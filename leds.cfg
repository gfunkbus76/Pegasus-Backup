#####################################################################
#                       NEOPIXEL HARDWARE                           #
#####################################################################

[neopixel sb_leds]
pin: H36_combo:PA8 #IO.2/RGB0
chain_count: 3
color_order: GRBW
initial_RED: 0.5 
initial_GREEN: 0.5
initial_BLUE: 0.5
initial_WHITE: 0.5

[neopixel gantry]
pin: PA9
chain_count: 24
color_order: GRB
# Set Green on Boot (Idle State) - No White Channel
initial_RED: 0.0
initial_GREEN: 0.5
initial_BLUE: 0.0

[neopixel enclosure]
pin: PB15
chain_count: 24
color_order: GRB
# Set Green on Boot (Idle State) - No White Channel
initial_RED: 0.0
initial_GREEN: 0.5
initial_BLUE: 0.0


#####################################################################
#                          HELPER MACROS                            #
#####################################################################

[gcode_macro _APPLY_LEDS]
description: Helper to apply colors to all strips efficiently
gcode:
    {% set logo = params.LOGO|default("0,0,0,0") %}
    {% set nozzle = params.NOZZLE|default("0,0,0,0") %}
    {% set case = params.CASE|default("0,0,0,0") %}

    # Split strings into RGBA lists
    {% set logo_c = logo.split(',') %}
    {% set nozzle_c = nozzle.split(',') %}
    {% set case_c = case.split(',') %}

    # Set Toolhead LEDs (SB_LEDS uses RGBW)
    SET_LED LED=sb_leds INDEX=1 RED={logo_c[0]} GREEN={logo_c[1]} BLUE={logo_c[2]} WHITE={logo_c[3]} TRANSMIT=0
    SET_LED LED=sb_leds INDEX=2 RED={nozzle_c[0]} GREEN={nozzle_c[1]} BLUE={nozzle_c[2]} WHITE={nozzle_c[3]} TRANSMIT=0
    SET_LED LED=sb_leds INDEX=3 RED={nozzle_c[0]} GREEN={nozzle_c[1]} BLUE={nozzle_c[2]} WHITE={nozzle_c[3]} TRANSMIT=0

    # Set Case LEDs (Gantry uses RGB - No White)
    SET_LED LED=gantry RED={case_c[0]} GREEN={case_c[1]} BLUE={case_c[2]} TRANSMIT=0
    
    # Set Case LEDs (Enclosure uses RGB - No White)
    # Triggering the last strip transmits data for all previous TRANSMIT=0 commands
    SET_LED LED=enclosure RED={case_c[0]} GREEN={case_c[1]} BLUE={case_c[2]} TRANSMIT=1
    
    # Force update SB_LEDS to ensure sync across MCUs
    SET_LED LED=sb_leds RED={logo_c[0]} GREEN={logo_c[1]} BLUE={logo_c[2]} WHITE={logo_c[3]} TRANSMIT=1 

[gcode_macro SET_CASE_LIGHTS]
description: Manually control gantry and enclosure lights only (RGB Only)
gcode:
    {% set r = params.R|default(0)|float %}
    {% set g = params.G|default(0)|float %}
    {% set b = params.B|default(0)|float %}
    # White param ignored for RGB case lights
    
    SET_LED LED=gantry RED={r} GREEN={g} BLUE={b} TRANSMIT=0
    SET_LED LED=enclosure RED={r} GREEN={g} BLUE={b} TRANSMIT=1


#####################################################################
#                          STATUS MACROS                            #
#####################################################################

# Case Logic:
# Green = Ready/Idle (0.0, 0.5, 0.0)
# Red   = Busy       (0.5, 0.0, 0.0)

[gcode_macro status_off]
gcode:
    _APPLY_LEDS LOGO="0,0,0,0" NOZZLE="0,0,0,0" CASE="0,0,0,0"

[gcode_macro status_ready]
gcode:
    # SB Logo: Dim White | Case: Green
    _APPLY_LEDS LOGO="0.01,0.01,0.01,0.1" NOZZLE="0,0,0,0" CASE="0.0,0.5,0.0,0.0"

[gcode_macro status_busy]
gcode:
    # SB Logo: Red | Case: Red
    _APPLY_LEDS LOGO="0.4,0,0,0" NOZZLE="0.8,0.8,0.8,1" CASE="0.5,0.0,0.0,0.0"

[gcode_macro status_heating]
gcode:
    # SB Logo: Orange | Case: Red
    _APPLY_LEDS LOGO="0.3,0.18,0,0" NOZZLE="0.8,0.35,0,0" CASE="0.5,0.0,0.0,0.0"

[gcode_macro status_leveling]
gcode:
    # SB Logo: Pink | Case: Red
    _APPLY_LEDS LOGO="0.5,0.1,0.4,0" NOZZLE="0.8,0.8,0.8,1" CASE="0.5,0.0,0.0,0.0"

[gcode_macro status_homing]
gcode:
    # SB Logo: Cyan | Case: Red
    _APPLY_LEDS LOGO="0,0.6,0.2,0" NOZZLE="0.8,0.8,0.8,1" CASE="0.5,0.0,0.0,0.0"

[gcode_macro status_cleaning]
gcode:
    # SB Logo: Blue | Case: Red
    _APPLY_LEDS LOGO="0,0.02,0.5,0" NOZZLE="0.8,0.8,0.8,1" CASE="0.5,0.0,0.0,0.0"

[gcode_macro status_meshing]
gcode:
    # SB Logo: Green | Case: Red
    _APPLY_LEDS LOGO="0.2,1,0,0" NOZZLE="0.8,0.8,0.8,1" CASE="0.5,0.0,0.0,0.0"

[gcode_macro status_calibrating_z]
gcode:
    # SB Logo: Red/Blue | Case: Red
    _APPLY_LEDS LOGO="0.8,0,0.35,0" NOZZLE="0.8,0.8,0.8,1" CASE="0.5,0.0,0.0,0.0"

[gcode_macro status_printing]
gcode:
    # SB Logo: Red | Case: Red
    _APPLY_LEDS LOGO="1,0,0,0" NOZZLE="0.8,0.8,0.8,1" CASE="0.5,0.0,0.0,0.0"

[gcode_macro set_nozzle_leds_on]
gcode:
    SET_LED LED=sb_leds INDEX=2 RED=0.8 GREEN=0.8 BLUE=0.8 WHITE=1 TRANSMIT=0
    SET_LED LED=sb_leds INDEX=3 RED=0.8 GREEN=0.8 BLUE=0.8 WHITE=1

[gcode_macro set_nozzle_leds_off]
gcode:
    SET_LED LED=sb_leds INDEX=2 RED=0 GREEN=0 BLUE=0 WHITE=0 TRANSMIT=0
    SET_LED LED=sb_leds INDEX=3 RED=0 GREEN=0 BLUE=0 WHITE=0
