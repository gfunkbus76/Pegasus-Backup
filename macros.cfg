#    STATUS_READY
#    STATUS_OFF
#    STATUS_BUSY
#    STATUS_HEATING
#    STATUS_LEVELING
#    STATUS_HOMING
#    STATUS_CLEANING
#    STATUS_MESHING
#    STATUS_CALIBRATING_Z

#####################################################################
# 	Start - End - Cancel - Pause
#####################################################################

#[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customize for your slicer of choice
# default_parameter_BED_TEMP: 110
# default_parameter_EXTRUDER_TEMP: 250
#gcode:
[gcode_macro PRINT_START]
gcode:
  # This part fetches data from your slicer. Such as bed temp, extruder temp, chamber temp and size of your printer.
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  # Homes the printer and sets absolute positioning
  STATUS_HOMING
  G28                   # Full home (XYZ)
  G90                   # Absolut position
  STATUS_HEATING
  # Checks if the bed temp is higher than 90c - if so then trigger a heatsoak
  {% if params.BED|int > 90 %}
    M106 S255                                         # Turns on the PT-fan

    ##  Uncomment if you have a Nevermore.
    #SET_PIN PIN=nevermore VALUE=1                    # Turns on the nevermore

    G1 X{x_wait} Y{y_wait} Z15 F9000                  # Goes to center of the bed
    M190 S{target_bed}                                # Sets target temp for the bed

  # If the bed temp is not over 90c then it skips the heatsoak and just heats up to set temp with a 5min soak.
  {% else %}
    G1 X{x_wait} Y{y_wait} Z15 F9000                # Goes to center of the bed
    M190 S{target_bed}                              # Sets target temp for the bed
    #G4 P300000                                      # Waits 5 min for the bedtemp to stabilize
  {% endif %}
  CQGL
  STATUS_MESHING
  BED_MESH_CALIBRATE
  SMART_PARK
  STATUS_HEATING
  # Heats up the nozzle up to target via slicer
  M107                                              # Turns off the PT-fan
  M109 S{target_extruder}                           # Heats the nozzle to your print temp
  STATUS_READY
  # Create a purge line and starts the print
  STATUS_CLEANING
  LINE_PURGE
  #G1 X5 Y4 Z0.4 F10000                             # Moves to starting point
  #G1 X115 E20 F1000                                # Purge line
  STATUS_PRINTING

 #   M117 Heating
 ##   M140 S{ params.BED } ; set bed final temp
  #  M104 S{ params.EXTRUDER } ; set extruder final temp
  #  M190 S{ params.BED } ; wait for final bed temp
  #  M109 S{ params.EXTRUDER } ; wait for final extruder temp
  #  G21 ; set units to millimeters
  #  G90 ; use absolute coordinates
  #  M83 ; use relative distances for extrusion
  #  G28
  #  BED_MESH_CALIBRATE
  #  #SET_GCODE_OFFSET Z=-1.04
  #  M117 Printing
  #  LINE_PURGE
  #  #VORON_PURGE

[gcode_macro BED_MESH]
gcode:
    G28
    BED_MESH_CALIBRATE PROFILE=default
    BED_MESH_PROFILE LOAD=default
    SAVE_CONFIG

#[gcode_macro PRINT_END]
#gcode:
  #  STATUS_BUSY
  #  M221 S100
 #   M104 S0 ; turn off temperature
 #   M140 S0 ; turn off heatbed
 #   M107 ; turn off fan 
 #   # Raise nozzle by 10mm
 #   G91
 #   G1 Z10 F8000
 #   G90
 #   G1 X0 Y222 E-3 F8000
 #   M84 ; disable motors


[gcode_macro PRINT_END]
gcode:
    # --- SAFETY VARIABLES ---
    # Get the maximum Z height from the config and current Z position
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    
    # Define how much you WANT to lift (10mm)
    {% set lift_z = 10.0 %}
    
    # Check if lifting 10mm would hit the ceiling. 
    # If yes, set lift distance to the remaining space.
    {% if act_z + lift_z > max_z %}
        {% set lift_z = max_z - act_z %}
    {% endif %}
    # ------------------------

    STATUS_BUSY
    M221 S100
    M104 S0 ; turn off temperature
    M140 S0 ; turn off heatbed
    M107 ; turn off fan 
    
    G91 ; Switch to Relative Positioning
    
    # Retract 3mm (Safe here because we are in Relative Mode)
    G1 E-3 F3000 
    
    # Lift Z by the calculated safe amount
    G1 Z{lift_z} F8000 
    
    G90 ; Switch back to Absolute Positioning
    
    # Park Toolhead (Removed the E-3 from here to prevent the crash)
    G1 X200 Y380 F8000 
    
    M84 ; disable motors
    

[gcode_macro SCREW_CALC]
gcode:
    G28
    SCREWS_TILT_CALCULATE
    M18





# Heat Soak Bed Only Macro for Klipper
#
# Usage: HEAT_SOAK_BED BED=<temperature> DURATION=<minutes>
#
# Parameters:
#   BED: Target bed temperature in degrees Celsius. (Required)
#   DURATION: Duration of the heat soak in minutes. (Required)

[gcode_macro HEAT_SOAK_BED]
gcode:
    {% set bed_temp = params.BED|default(0)|float %}
    {% set duration = params.DURATION|default(0)|float * 60 %} # Convert minutes to seconds

    {% if bed_temp == 0 or duration == 0 %}
        { action_respond_info("HEAT_SOAK_BED: Invalid parameters. BED and DURATION are required.") }
    {% else %}
        { action_respond_info("HEAT_SOAK_BED: Starting bed heat soak. Bed: " + bed_temp|string + "C, Duration: " + (duration / 60)|string + " minutes.") }

        M140 S{bed_temp} # Set bed temperature
        M190 S{bed_temp} # Wait for bed temperature

        G4 P{duration * 1000} # Wait for duration (milliseconds)

        { action_respond_info("HEAT_SOAK_BED: Bed heat soak complete.") }

    {% endif %}


[gcode_macro TEST_SGT]
description: Test SGT values for TMC2240. Usage: TEST_SGT SGT=15 AXIS=X
gcode:
    {% set sgt = params.SGT|default(15)|int %}
    {% set axis = params.AXIS|default('x')|string|lower %}
    
    RESPOND MSG="Testing SGT value: {sgt} on {axis}"
    
    # 1. Set the SGT value dynamically
    SET_TMC_FIELD STEPPER=stepper_{axis} FIELD=sgt VALUE={sgt}
    
    # 2. Wait for SPI to settle
    G4 P250
    
    # 3. Fake a position so we can move away from the wall
    # This tricks Klipper into thinking we are at 200mm
    SET_KINEMATIC_POSITION {axis}=200
    G91               ; Relative positioning
    G0 {axis}-10 F3000 ; Move back 10mm to give running room
    G90               ; Absolute positioning
    
    # 4. Attempt to home
    G28 {axis}


#Conditional QGL: If QGL'd already, will not run again
[gcode_macro CQGL]
gcode:
    {% if printer.quad_gantry_level.applied == False %}
        QUAD_GANTRY_LEVEL
        
    {% endif %}



[gcode_macro TEST_SPEED]
# Home, get position, throw around toolhead, home again.
# If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your number of microsteps), then skipping occured.
# We only measure to a full step to accomodate for endstop variance.
# Example: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10

description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU

gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Minimum Cruise Ratio
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    # Bounding inset for large pattern (helps prevent slamming the toolhead into the sides after small skips, and helps to account for machines with imperfectly set dimensions)
    {% set bound = params.BOUND|default(20)|int %}
    # Size for small pattern box
    {% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
    
    # Large pattern
        # Max positions, inset by BOUND
        {% set x_min = printer.toolhead.axis_minimum.x %}
        {% if x_min < 0 %}
            {% set x_min = 0 %}
        {% endif %}
    
        {% set y_min = printer.toolhead.axis_minimum.y %}
        {% if y_min < 0 %}
            {% set y_min = 0 %}
        {% endif %}
    
        {% set x_min = x_min + bound %}
        {% set x_max = printer.toolhead.axis_maximum.x - bound %}
        {% set y_min = y_min + bound %}
        {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Small pattern at center
        # Find X/Y center point
        {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
        {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
        
        # Set small pattern box around center point
        {% set x_center_min = x_center - (smallpatternsize/2) %}
        {% set x_center_max = x_center + (smallpatternsize/2) %}
        {% set y_center_min = y_center - (smallpatternsize/2) %}
        {% set y_center_max = y_center + (smallpatternsize/2) %}

    # Save current gcode state (absolute/relative, etc)
    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    # Output parameters to g-code terminal
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    
    # Home and get position for comparison later:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28
        # QGL if not already QGLd (only if QGL section exists in config)
        {% if printer.configfile.settings.quad_gantry_level %}
            {% if printer.quad_gantry_level.applied == False %}
                QUAD_GANTRY_LEVEL
                G28 Z
            {% endif %}
        {% endif %} 
        # Move 50mm away from max position and home again (to help with hall effect endstop accuracy - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/24)
        G90
        G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 X Y
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Go to starting position
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

    # Set new limits
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
    {% endif %}

    {% for i in range(iterations) %}
        # Large pattern diagonals
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        
        # Large pattern box
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
    
        # Small pattern diagonals
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        
        # Small pattern box
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    # Restore max speed/accel/accel_to_decel to their configured values
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio} 
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    # Re-home and get position again for comparison:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 # This is a full G28 to fix an issue with CoreXZ - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/12
        # Go to XY home positions (in case your homing override leaves it elsewhere)
        G90
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Restore previous gcode state (absolute/relative, etc)
    RESTORE_GCODE_STATE NAME=TEST_SPEED



[gcode_macro update_git]
gcode:
    {% set message = params.MESSAGE|default() %}
    {% if message %}
        RUN_SHELL_COMMAND CMD=update_git_script_message PARAMS="'{params.MESSAGE}'"
    {% else %}
        RUN_SHELL_COMMAND CMD=update_git_script
    {% endif %}

[gcode_shell_command update_git_script]
command: bash -c "bash $HOME/klipper-backup/script.sh"
timeout: 90.0
verbose: True

[gcode_shell_command update_git_script_message]
command: bash -c "bash $HOME/klipper-backup/script.sh -c \"$0\""
timeout: 90.0
verbose: True